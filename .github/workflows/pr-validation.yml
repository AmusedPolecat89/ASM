name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch base
        run: git fetch --depth=1 origin "${{ github.base_ref }}"

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: 1.75.0
          components: rustfmt, clippy
          override: true

      - name: Cargo fmt
        run: cargo fmt --all -- --check

      - name: Cargo clippy
        run: cargo clippy --workspace --all-targets -- -D warnings

      - name: Cargo test
        run: cargo test

      - name: Cargo doc tests
        run: cargo test --doc

      - name: Size and path guard
        run: |
          set -euo pipefail
          LARGE_FILES=$(find . -type f -size +5M \
            ! -path './.git/*' \
            ! -path './target/*')
          if [[ -n "$LARGE_FILES" ]]; then
            echo "Files larger than 5 MB detected:" >&2
            echo "$LARGE_FILES" >&2
            exit 1
          fi
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }})
          if echo "$CHANGED" | grep -E '^(runs/|summary/|repro/)' >/dev/null; then
            echo "Changes under runs/, summary/, or repro/ are not allowed" >&2
            exit 1
          fi
          if echo "$CHANGED" | grep -E '^crates/.*/src/lib.rs' >/dev/null || \
             echo "$CHANGED" | grep -E '^crates/asm-sim/src/commands/' >/dev/null; then
            if ! echo "$CHANGED" | grep -q '^CHANGELOG.md'; then
              echo "Public API updates require a CHANGELOG.md entry" >&2
              exit 1
            fi
          fi

      - name: Run ablation (topo_vs_worm)
        run: scripts/run_ablation.sh ablation/plans/topo_vs_worm.yaml --seed 9001

      - name: Upload ablation artefacts
        uses: actions/upload-artifact@v4
        with:
          name: ablation-topo_vs_worm
          path: |
            ablation/out/topo_vs_worm
            registry/asm.sqlite
          if-no-files-found: warn

      - name: Post KPI summary
        if: github.event.pull_request.draft == false
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = 'ablation/out/topo_vs_worm/diff.json';
            if (!fs.existsSync(path)) {
              core.info('Diff file not found; skipping comment');
              return;
            }
            const diff = JSON.parse(fs.readFileSync(path, 'utf8'));
            if (!diff.jobs) {
              core.info('Diff payload missing jobs');
              return;
            }
            let body = '### Ablation KPI deltas (topo\\_vs\\_worm)\n\n';
            body += '| Job | KPI | Δ | Allowed | Pass |\n| --- | --- | --- | --- | --- |\n';
            for (const job of diff.jobs) {
              for (const [name, payload] of Object.entries(job.metrics)) {
                body += `| ${job.job} | ${name} | ${payload.abs_delta.toExponential(2)} | ${payload.allowed.toExponential(2)} | ${payload.pass ? '✅' : '❌'} |\n`;
              }
            }
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });
