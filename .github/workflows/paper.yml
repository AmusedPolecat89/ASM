name: Preprint Release Candidate

on:
  push:
    tags:
      - v1.0.0-rc*

jobs:
  build-paper:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: 1.75.0
          override: true
          components: rustfmt, clippy

      - name: Cargo fmt
        run: cargo fmt --all -- --check

      - name: Cargo clippy
        run: cargo clippy --workspace --all-targets -- -D warnings

      - name: Cargo test
        run: cargo test

      - name: Cargo doc tests
        run: cargo test --doc

      - name: Replication suite
        run: ./replication/run.sh

      - name: Render dashboards
        run: |
          python3 scripts/render_dashboards.py \
            --replication replication/out \
            --expected replication/expected \
            --registry registry \
            --fixtures fixtures/phase10 \
            --out dashboards

      - name: Build paper
        run: bash scripts/build_paper.sh

      - name: Size guard
        run: |
          set -euo pipefail
          LARGE_FIGS=$(find paper/figures -type f -size +1M || true)
          if [[ -n "$LARGE_FIGS" ]]; then
            echo "Figures larger than 1 MB detected:" >&2
            echo "$LARGE_FIGS" >&2
            exit 1
          fi
          LARGE_JSON=$(find dashboards -type f -name '*.json' -size +2M || true)
          if [[ -n "$LARGE_JSON" ]]; then
            echo "JSON artefacts larger than 2 MB detected:" >&2
            echo "$LARGE_JSON" >&2
            exit 1
          fi

      - name: Upload paper
        uses: actions/upload-artifact@v4
        with:
          name: asm-preprint
          path: |
            paper/paper.pdf
            paper/figures/*.pdf

      - name: Upload dashboards
        uses: actions/upload-artifact@v4
        with:
          name: asm-dashboards
          path: dashboards/*.md
